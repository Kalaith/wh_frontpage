name: CI

on:
  pull_request:
    branches: [main, master, development]
  push:
    branches: [main, master, development]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Run type checking
        run: npm run type-check

      - name: Run tests
        run: npm run test:run

      - name: Build application
        run: npm run build

      - name: Check build artifacts
        run: |
          if [ ! -d "dist" ]; then
            echo "Build failed - dist directory not found"
            exit 1
          fi
          if [ ! -f "dist/index.html" ]; then
            echo "Build failed - index.html not found"
            exit 1
          fi
          echo "Build successful - artifacts verified"

  update-manifest:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Check if should skip
        id: check_skip
        run: |
          # Get commit message safely and clean it
          COMMIT_MSG="${{ github.event.head_commit.message || github.event.commits[0].message || 'No message' }}"
          # Clean the commit message - use jq for proper JSON escaping and remove newlines
          COMMIT_MSG=$(echo "$COMMIT_MSG" | jq -Rs . | jq -r 'gsub("\\n";" ") | .[0:200]')
          echo "commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT
          
          # Check if we should skip
          if [[ "$COMMIT_MSG" == *"[skip ci]"* ]] || [[ "$COMMIT_MSG" == *"Update project manifest"* ]]; then
            echo "should_skip=true" >> $GITHUB_OUTPUT
            echo "Skipping manifest update - commit message: $COMMIT_MSG"
          else
            echo "should_skip=false" >> $GITHUB_OUTPUT
            echo "Proceeding with manifest update - commit message: $COMMIT_MSG"
          fi

      - name: Update project.json with git info
        if: steps.check_skip.outputs.should_skip != 'true'
        run: |
          # Read existing manifest or create new one
          if [ -f "project.json" ]; then
            manifest=$(cat project.json)
          else
            manifest='{"name":"frontpage","status":"active","deployment":{}}'
          fi

          # Safely get commit message and escape it for JSON
          SAFE_MESSAGE="${{ steps.check_skip.outputs.commit_message }}"
          
          # Update with git information using proper JSON escaping
          echo "$manifest" | jq --arg commit "$GITHUB_SHA" \
            --arg updated "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --arg branch "$GITHUB_REF_NAME" \
            --arg message "$SAFE_MESSAGE" \
            '.gitCommit = $commit | .lastUpdated = $updated | .branch = $branch | .lastCommitMessage = $message' \
            > project.json.tmp
          
          # Check if jq succeeded
          if [ $? -eq 0 ] && [ -f "project.json.tmp" ]; then
            mv project.json.tmp project.json
            echo "Project manifest updated successfully"
          else
            echo "Error: Failed to update project.json with jq"
            # Fallback: create a basic manifest without the problematic commit message
            echo "$manifest" | jq --arg commit "$GITHUB_SHA" \
              --arg updated "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              --arg branch "$GITHUB_REF_NAME" \
              '.gitCommit = $commit | .lastUpdated = $updated | .branch = $branch | .lastCommitMessage = "Merge commit"' \
              > project.json
          fi

      - name: Commit updated manifest
        if: steps.check_skip.outputs.should_skip != 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add project.json
          
          if ! git diff --staged --quiet; then
            git commit -m "Update project manifest [skip ci]"
            git push
            echo "Project manifest updated successfully"
          else
            echo "No changes to project.json manifest"
          fi